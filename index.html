<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <meta name="description" content="Space Invaders Game - A modern implementation with advanced rendering and game loop">
    <meta name="theme-color" content="#000000">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <!-- Security headers -->
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <meta http-equiv="X-Content-Type-Options" content="nosniff">
    <meta http-equiv="Referrer-Policy" content="strict-origin-when-cross-origin">
    
    <title>Space Invaders</title>
    
    <style>
        /* Critical rendering path styles */
        body {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        #game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        #game-canvas {
            background: #000;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            border: 1px solid #333;
        }
        
        .loading {
            color: #fff;
            font-size: 1.2em;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
        }
        
        .error {
            color: #ff4444;
            padding: 20px;
            text-align: center;
            display: none;
        }
    </style>
</head>
<body>
    <!-- Game container with fallback -->
    <div id="game-container">
        <canvas id="game-canvas" width="800" height="600">
            Your browser does not support the canvas element.
        </canvas>
        <div id="loading" class="loading">Loading game engine...</div>
        <div id="error" class="error"></div>
    </div>

    <!-- Error handling and initialization -->
    <script type="module">
        // Import constants from the available config file
        import { CANVAS } from './src/config/constants.js';
        
        // Import core modules - these are available based on the project structure
        import Canvas from './src/core/Canvas.js';
        import GameLoop from './src/core/GameLoop.js';
        import Renderer from './src/core/Renderer.js';
        import PerformanceMonitor from './src/utils/Performance.js';
    
        // Initialize game components with error boundary
        async function initializeGame() {
            try {
                // Show loading state
                const loadingElement = document.getElementById('loading');
                loadingElement.style.display = 'block';
    
                                // Initialize core components with proper config
                const canvas = new Canvas({
                    width: CANVAS.WIDTH,
                    height: CANVAS.HEIGHT,
                    backgroundColor: CANVAS.BACKGROUND_COLOR
                });
                
                // Replace the existing canvas element with the new one
                const gameContainer = document.getElementById('game-container');
                const existingCanvas = document.getElementById('game-canvas');
                if (existingCanvas) {
                    existingCanvas.remove();
                }
                gameContainer.appendChild(canvas.getElement());
                
                const renderer = new Renderer(canvas.getElement());
                const performanceMonitor = new PerformanceMonitor();
                const gameLoop = new GameLoop({
                    targetFPS: CANVAS.FPS,
                    debug: true
                });

                // Set pixel ratio for high DPI displays
                const pixelRatio = CANVAS.PIXEL_RATIO;
                if (pixelRatio > 1) {
                    canvas.resize(CANVAS.WIDTH * pixelRatio, CANVAS.HEIGHT * pixelRatio);
                    canvas.getElement().style.width = `${CANVAS.WIDTH}px`;
                    canvas.getElement().style.height = `${CANVAS.HEIGHT}px`;
                }
    
                // Hide loading state
                loadingElement.style.display = 'none';
    
                // Start game loop with update and render functions
                gameLoop.start(
                    // Update function
                    (deltaTime) => {
                        // Game state update logic will go here
                        // For now, just track performance
                    },
                    // Render function
                    () => {
                        performanceMonitor.startFrame();
                        renderer.clear();
                        
                        // Test rendering - draw a simple rectangle
                        renderer.drawEntity({
                            x: 100,
                            y: 100,
                            width: 50,
                            height: 50,
                            color: '#00ff00'
                        });
                        
                        renderer.render();
                        performanceMonitor.endFrame();
                    }
                );
    
                // Global error handler
                window.onerror = (msg, url, line, col, error) => {
                    handleError('Runtime Error', error);
                    gameLoop.stop();
                };
    
            } catch (error) {
                handleError('Initialization Error', error);
            }
        }
    
        // Centralized error handling
        function handleError(type, error) {
            console.error(`${type}:`, error);
            const errorDiv = document.getElementById('error');
            if (errorDiv) {
                errorDiv.style.display = 'block';
                errorDiv.textContent = `${type}: ${error.message}. Please refresh the page.`;
            }
            
            // Hide loading indicator if visible
            const loadingElement = document.getElementById('loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        }
    
        // Initialize game when DOM is ready
        document.addEventListener('DOMContentLoaded', initializeGame);
    </script>
    
</body>
</html>